# Сервис группировки стандартных товарных единиц (СТЕ)

Сервис для группировки стандартных товарных единиц по их значимым характеристикам для Портала поставщиков.

## Описание

Сервис реализует интеллектуальную группировку СТЕ по значимым характеристикам с использованием:
- Анализа частоты характеристик для определения значимых признаков категорий
- Группировки по точному совпадению характеристик
- Объединения похожих групп на основе семантической схожести (используется легковесная ML-модель)
- Возможности ручного редактирования агрегаций

### Основные возможности:
- ✅ Обработка и анализ данных о СТЕ, включая характеристики товаров
- ✅ Автоматическое определение значимых характеристик для каждой категории товаров
- ✅ Интеллектуальная группировка СТЕ по значимым характеристикам
- ✅ Поиск СТЕ по названию, производителю, модели и другим атрибутам
- ✅ Вручную редактирование агрегаций (добавление, удаление, изменение порядка СТЕ)
- ✅ Оценка агрегации пользователем (1-5 баллов)
- ✅ Сохранение и перегенерация агрегации

## Установка

1. Убедитесь, что установлен Python 3.10 или выше

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Импортируйте данные из Excel файла:
```bash
python scripts/import_data.py
```

## Запуск

```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

API документация (Swagger) доступна по адресу: http://localhost:8000/docs

## Структура проекта

```
tenderhack/
├── app/                      # Основной код приложения
│   ├── main.py              # Точка входа FastAPI
│   ├── config.py            # Конфигурация приложения
│   ├── models/              # Модели данных
│   │   ├── database.py      # SQLAlchemy модели
│   │   └── schemas.py       # Pydantic схемы для API
│   ├── api/                 # API endpoints
│   │   └── v1/
│   │       ├── ste.py       # Эндпоинты для работы со СТЕ
│   │       ├── grouping.py  # Эндпоинты для группировки
│   │       ├── aggregation_edit.py  # Редактирование агрегаций
│   │       └── rating.py    # Оценка агрегаций
│   ├── services/            # Бизнес-логика
│   │   ├── characteristic_analyzer.py  # Анализ значимых характеристик
│   │   └── grouping_service.py         # Сервис группировки
│   ├── parsers/             # Парсеры данных
│   │   └── excel_parser.py  # Парсер Excel файлов
│   └── database/            # Работа с БД
│       └── base.py          # Настройки БД
├── scripts/                 # Вспомогательные скрипты
│   └── import_data.py       # Импорт данных из Excel
├── data/                    # Исходные данные
│   └── Исходные данные_Хакатон_Казань_20251128_1800.xlsx
├── requirements.txt         # Зависимости
└── README.md               # Документация
```

## API Endpoints

### СТЕ (Standard Trading Entities)
- `GET /api/v1/ste/` - Поиск СТЕ по запросу
- `GET /api/v1/ste/{ste_id}` - Получить СТЕ по ID
- `POST /api/v1/ste/import` - Импорт СТЕ из Excel

### Группировка
- `POST /api/v1/grouping/` - Группировка СТЕ
- `GET /api/v1/grouping/aggregations` - Список агрегаций
- `GET /api/v1/grouping/aggregations/{aggregation_id}` - Детали агрегации

### Редактирование агрегаций
- `POST /api/v1/aggregations/{aggregation_id}/items/{ste_id}` - Добавить СТЕ в агрегацию
- `DELETE /api/v1/aggregations/{aggregation_id}/items/{item_id}` - Удалить СТЕ из агрегации
- `PUT /api/v1/aggregations/{aggregation_id}/items/{item_id}/order` - Изменить порядок СТЕ
- `POST /api/v1/aggregations/{aggregation_id}/save` - Сохранить агрегацию
- `DELETE /api/v1/aggregations/{aggregation_id}` - Удалить агрегацию

### Оценки
- `POST /api/v1/ratings/aggregations/{aggregation_id}` - Поставить оценку агрегации
- `GET /api/v1/ratings/aggregations/{aggregation_id}` - Получить оценки агрегации

## Особенности реализации

1. **Обработка множественных листов**: Парсер автоматически обрабатывает все листы в Excel файле

2. **Гибкий парсинг характеристик**: Поддержка различных форматов характеристик:
   - "Ключ1:Значение1;Ключ2:Значение2"
   - "Ключ1: Значение1 ;Ключ2: Значение2"
   - Обработка отсутствующих характеристик

3. **Нормализация и обработка ошибок**:
   - Нормализация текста для обработки орфографических ошибок
   - Группировка похожих характеристик с учетом вариаций написания
   - Обработка товаров без характеристик (используются альтернативные признаки: производитель, модель, название)

4. **Анализ значимых характеристик**: Система автоматически анализирует частоту использования характеристик в каждой категории и определяет значимые (используются минимум в 30% СТЕ категории, с автоматической корректировкой для категорий с малым количеством характеристик)

2. **Двухэтапная группировка**:
   - Сначала группировка по точному совпадению значений значимых характеристик
   - Затем объединение похожих групп на основе семантической схожести названий

3. **Легковесная ML-модель**: Используется `paraphrase-multilingual-MiniLM-L12-v2` для вычисления схожести - легковесная модель с высокой скоростью инференса

4. **База данных**: SQLite с асинхронным доступом для быстрой работы

5. **Swagger документация**: Полная автоматическая документация всех API endpoints с примерами запросов и ответов

